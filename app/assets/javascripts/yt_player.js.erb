function onYouTubePlayerReady(player_id){
    yt_player = document.getElementById('my_yt_player');
    yt_player.addEventListener("onStateChange", "nextSong");
}


function nextSong(newState){
    if (newState == 0){
        $('.yt_button').each(function(index){
            if ($(this).attr('now_playing') == 'true'){
                $(this).parent().parent().next().find('.yt_button').trigger('click');
            }
         });
    }
};

$(document).on('ajax:complete', function(){

    var params = { allowScriptAccess: "always" };
    var atts = {id: "my_yt_player"};
    swfobject.embedSWF("http://www.youtube.com/apiplayer?enablejsapi=1", "yt_player", "0", "0", "8",null, null, params, atts);
    $('#my_yt_player').css('position', 'absolute');


    function currentSong(song_id){
        return song_id;
    };

    $('.track_list_item').hover(
        function(){
            $(this).find('.remove').css('visibility', 'visible');
            $(this).find('td').css('visibility', 'visible');
            $(this).find('.now_playing_icon').find('img').attr('src', '/assets/pause_icon.png');
            $(this).find('.now_playing_paused_icon').find('img').attr('src', '/assets/play_icon.png');
        },
        function(){
            $(this).find('.remove').css('visibility', 'hidden');
            $(this).find('.not_playing_icon').css('visibility', 'hidden');
            $(this).find('.now_playing_icon, .now_playing_paused_icon').find('img').attr('src', '/assets/speaker_icon.png')
        }
    );

    function showOrHidePlayImage(){
        $('.now_playing_icon').each(function(){
            $(this).attr('class', 'not_playing_icon').css('visibility', 'hidden');
            $(this).parent().parent().find('.not_playing_icon img').attr('src', '/assets/play_icon.png');
        });
        $('.yt_button').each(function(){
            if ($(this).attr('now_playing') == 'true'){
                var row = $(this).parent().parent()
                row.find('.not_playing_icon, .now_playing_paused_icon').attr('class', 'now_playing_icon').css('visibility', 'visible');
                row.find('.now_playing_icon img').attr('src', '/assets/pause_icon.png');
            }else if ($(this).attr('now_playing') == 'paused'){
                var row = $(this).parent().parent()
                row.find('.not_playing_icon').attr('class', 'now_playing_paused_icon').css('visibility', 'visible');
                row.find('.now_playing_icon img').attr('src', '/assets/play_icon.png');
            }
        });
    };

    $('.yt_button').off("click");

    $('.yt_button').click(function(){
        if ($(this).attr('now_playing') == 'false'){
            $('#play_pause').html('Pause');
            var song_id = $(this).attr('yt_id');
            yt_player.loadVideoById(song_id, 1, 'large');
            $('.yt_button').each(function(){
                if (song_id == $(this).attr('yt_id')){
                    $(this).attr('now_playing', 'true');
                }else{
                    $(this).attr('now_playing', 'false');
                }
            });

        }else if ($(this).attr('now_playing') == 'true'){
            $('#play_pause').trigger('click');
            $(this).attr('now_playing', 'paused');
            alert("should pause");
        }else if ($(this).attr('now_playing') == 'paused'){
            $(this).attr('now_playing', 'true');
            $('#play_pause').trigger('click');
        };
        showOrHidePlayImage();
        return false;
    });


    $('#play_pause').toggle(function(){
            yt_player.pauseVideo();
            $(this).html('Play');
        }, function(){
            yt_player.playVideo();
            $(this).html('Pause');
    });

    $('.start_over').click(function(){
        yt_player.pauseVideo();
    });


});

